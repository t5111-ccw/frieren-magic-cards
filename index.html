<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>芙莉蓮的魔法卡冊與人氣榜</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設置襯線字體（Serif），使其看起來更像魔導書。 */
        body {
            font-family: 'Times New Roman', Georgia, serif, 'Noto Sans TC';
        }
        
        /* 提高堆疊中卡片的層次感和邊框細節 */
        .card-stack .spell-card {
            /* 1. 絕對定位，使卡片重疊 */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* 2. 卡片外觀 */
            background: white;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.2), 0 5px 10px -2px rgba(0, 0, 0, 0.05); /* 增強陰影 */
            border: 4px solid #FCD34D; /* 淺金色邊框，增強魔法書質感 */
            
            /* 3. 內容排版 */
            display: flex;
            flex-direction: column;
            padding: 2rem; /* p-8 */
            
            /* 4. 防止拖曳時選取文字 */
            user-select: none;
            
            /* 5. 設置過渡動畫 (用於放手時的歸位) */
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* 使用彈性動畫 */

            /* 6. 設置 cursor 樣式 */
            cursor: grab;
            
            /* 7. 確保卡片內容在拖曳時清晰 */
            z-index: 10;
        }
        
        /* 堆疊中第二張卡片的樣式 */
        .card-stack .spell-card:nth-child(2) {
            transform: scale(0.95) translateY(15px);
            z-index: 5;
            opacity: 0.85;
            border-color: #FED7AA; /* 次要卡片使用較淡的邊框色 */
        }
        
        /* 第三張卡片 */
        .card-stack .spell-card:nth-child(3) {
            transform: scale(0.9) translateY(30px);
            z-index: 0;
            opacity: 0.7;
            border-color: #FED7AA;
        }
        
        /* 隱藏更後面的卡片 */
        .card-stack .spell-card:nth-child(n+4) {
            opacity: 0;
            z-index: -5;
        }

        /* 當卡片被拖曳時的樣式 */
        .card-stack .spell-card.dragging {
            transition: none; /* 拖曳時移除動畫，確保即時反饋 */
            cursor: grabbing;
            box-shadow: 0 20px 40px -8px rgba(0, 0, 0, 0.3); /* 拖曳時陰影更深 */
        }
        
        /* 卡片內文樣式 */
        .spell-description {
            height: 100px; /* 固定高度 */
            overflow-y: auto; 
            scrollbar-width: thin;
            scrollbar-color: #9CA3AF #F3F4F6;
        }

        /* 人氣榜樣式 */
        #leaderboard::-webkit-scrollbar {
            width: 6px;
        }
        #leaderboard::-webkit-scrollbar-thumb {
            background-color: #FCD34D;
            border-radius: 3px;
        }
        #leaderboard::-webkit-scrollbar-track {
            background: #fef3c7;
        }
    </style>
    <!-- 載入 Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, getDoc, runTransaction, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug'); // 啟用 Firebase 偵錯日誌

        // --- 全域變數 ---
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.currentCardIndex = 0;
        window.currentLeaderboard = [];
        window.spellData = []; // 用於儲存要循環的卡片資料
        
        // 來自 Heroicons 的 SVG 圖標 (保持不變)
        const ICONS = {
            flower: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.195l-2.073.193c-1.11.103-2.064.957-2.064 2.08V20.25c0 1.136-.847 2.1-1.98 2.195l-2.073.193c-1.11.103-2.064.957-2.064 2.08V20.25c0 1.136-.847 2.1-1.98 2.195l-2.073.193c-1.11.103-2.064.957-2.064 2.08V20.25" /><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 12.75l-1.01-1.01-1.01 1.01m1.01-1.01v-1.01h1.01m-1.01 1.01h-1.01v-1.01M3.75 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.195l-2.073.193C-.103 17.217-.947 16.263-.947 15.131v-4.286c0-.97.616-1.813 1.5-2.097L3.75 8.511zM12.75 3.75l-1.01 1.01-1.01-1.01m1.01 1.01v1.01h1.01m-1.01-1.01h-1.01v1.01m0 0v1.01M15 4.75l.939-.939a.95.95 0 011.061 0l.939.939M15 4.75l.939.939m-.939-.939v1.879M15 4.75h1.879m-1.879 0L13.94 3.811M9 4.75l-.939-.939a.95.95 0 00-1.061 0l-.939.939M9 4.75l-.939.939m.939-.939v1.879M9 4.75H7.121m1.879 0L10.06 3.811" /></svg>',
            grape: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            statue: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A1.5 1.5 0 0118 21.75H6a1.5 1.5 0 01-1.499-1.632z" /></svg>',
            burger: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0A2.25 2.25 0 0018.75 9.75H5.25A2.25 2.25 0 003 12m18 0a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12" /></svg>',
            tea: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-1.718-.668-3.322-1.872-4.526A4.498 4.498 0 009 0C7.161 0 5.5 1.66 5.5 3.75v.063c-.441.246-.85.539-1.208.882A4.5 4.5 0 000 8.25v3.75c0 1.683.806 3.19 2.009 4.093l.3.218c.847.62 1.935.939 3.065.939h6.38a.563.563 0 00.563-.563v-3.87a.563.563 0 00-.31-.5l-2.65-1.06a1.126 1.126 0 01-.562-1.332c.11-.27.27-.52.478-.736.209-.215.46-.38.74-.487.278-.106.574-.16.882-.16h.063c1.02 0 1.96.402 2.65 1.126l2.5 2.5c.26.26.628.402 1.006.402h3.116c1.1 0 2.097-.81 2.308-1.9l.792-4.062a2.25 2.25 0 00-2.16-2.618l-3.86-.551Z" /></svg>',
            clothes: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>',
            bird: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L5.999 12zm0 0h7.5" /></svg>',
            search: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>',
            egg: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
        };

        // 魔法卡片資料 (保持不變)
        const ORIGINAL_SPELL_DATA = [
            {
                id: "flower_magic",
                title: "變出花田的魔法",
                icon: ICONS.flower,
                color: "text-pink-600",
                description: "芙莉蓮最珍視的魔法之一。欣梅爾的故鄉盛開著蒼月草，這是他最喜歡的魔法，也是連結師傅弗蘭梅的魔法。"
            },
            {
                id: "grape_magic",
                title: "把甜葡萄變成酸葡萄的魔法",
                icon: ICONS.grape,
                color: "text-purple-700",
                description: "純粹是為了讓戰士艾冉開心而學的。艾冉唯一喜歡的甜點就是酸葡萄。"
            },
            {
                id: "statue_magic",
                title: "去除銅像生鏽的魔法",
                icon: ICONS.statue,
                color: "text-yellow-700",
                description: "欣梅爾過世後，芙莉蓮在旅途中用來「探望」老朋友的魔法，仔細地清潔他的雕像。"
            },
            {
                id: "burger_magic",
                title: "召喚超巨大漢堡排的魔法",
                icon: ICONS.burger,
                color: "text-orange-700",
                description: "僧侶海塔開玩笑想要的魔法。芙莉蓮真的花了好幾年去找，體現了她對夥伴願望的（笨拙）重視。"
            },
            {
                id: "tea_magic",
                title: "變出熱茶的魔法",
                icon: ICONS.tea,
                color: "text-green-700",
                description: "在寒冷的旅途中，能隨時喝到熱茶。這是芙莉蓮和費倫在日常中經常使用的便利魔法。"
            },
            {
                id: "clothes_magic",
                title: "能看透衣服的魔法",
                icon: ICONS.clothes,
                color: "text-blue-700",
                description: "「好色。」—— 費倫。芙莉蓮純粹出於魔法宅的好奇心而收藏，完全不明白這個魔法的倫理含意。"
            },
            {
                id: "bird_magic",
                title: "捕鳥的魔法",
                icon: ICONS.bird,
                color: "text-sky-700",
                description: "用途不明的魔法。但在某次旅途中，修塔爾克逃跑時，芙莉蓮曾用這個魔法把他抓回來。"
            },
            {
                id: "search_magic",
                title: "尋找失物的魔法",
                icon: ICONS.search,
                color: "text-gray-700",
                description: "在日常中非常實用，用來幫村民或夥伴尋找遺失的小東西，例如耳環或紀念品。"
            },
            {
                id: "egg_magic",
                title: "打碎雞蛋時蛋殼絕對不會掉進去的魔法",
                icon: ICONS.egg,
                color: "text-amber-700",
                description: "廚房的夢幻魔法。芙莉蓮花了不短的時間才從一本魔導書中學會它，是她熱衷於提升生活品質的證明。"
            }
        ];

        // --- 2. 變數與 DOM 元素定義 ---
        const stack = document.getElementById('card-stack');
        let isDragging = false;
        let startX = 0;
        let currentCard = null; // 當前正在互動的 DOM 卡片

        // -----------------------------------------------------
        // Firebase 與 Firestore 邏輯
        // -----------------------------------------------------

        // Firebase 初始化與認證
        const initFirebase = async () => {
            try {
                // 讀取全域提供的設定和 Token
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing.");
                    document.getElementById('status').textContent = '錯誤：Firebase 設定遺失。';
                    return;
                }

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('status').textContent = 'Firebase 連線成功，載入資料中...';

                window.spellData = ORIGINAL_SPELL_DATA; // 載入卡片資料
                await setupInitialCards();
                setupRealtimeLeaderboard();
                renderCardStack();

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                document.getElementById('status').textContent = `錯誤：Firebase 初始化失敗 (${error.message})`;
            }
        };

        // 設置初始卡片（如果不存在）
        const setupInitialCards = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const publicDataPath = `artifacts/${appId}/public/data/frieren_magic_cards`;
            
            const batch = writeBatch(window.db);
            let needsUpdate = false;

            for (const card of window.spellData) {
                const docRef = doc(window.db, publicDataPath, card.id);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    batch.set(docRef, {
                        title: card.title,
                        votes: 0 // 初始票數為 0
                    });
                    needsUpdate = true;
                }
            }

            if (needsUpdate) {
                await batch.commit();
            }
        };

        /**
         * 點擊蒐藏（增加票數）
         */
        window.collectCard = async () => {
            if (!window.db || !window.auth || window.spellData.length === 0) {
                alertUser('請稍候，系統仍在初始化...');
                return;
            }

            const card = window.spellData[window.currentCardIndex];
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(window.db, `artifacts/${appId}/public/data/frieren_magic_cards`, card.id);

            try {
                // 使用 Transaction 確保票數計數的原子性
                await runTransaction(window.db, async (transaction) => {
                    const cardDoc = await transaction.get(docRef);

                    if (cardDoc.exists()) {
                        const newVotes = (cardDoc.data().votes || 0) + 1;
                        transaction.update(docRef, { votes: newVotes });
                        alertUser(`成功蒐藏！「${card.title}」的票數已更新為 ${newVotes}。`);
                    } else {
                         // 數據缺失時，創建並設定初始票數 1
                        transaction.set(docRef, {
                            title: card.title,
                            votes: 1
                        });
                        alertUser(`成功蒐藏！已為「${card.title}」新增一票。`);
                    }
                });
            } catch (error) {
                console.error("Collecting card failed:", error);
                alertUser(`蒐藏失敗：${error.message}`, true);
            }
        };

        // 設置即時人氣榜監聽器
        const setupRealtimeLeaderboard = () => {
            if (!window.db) return;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const publicDataPath = `artifacts/${appId}/public/data/frieren_magic_cards`;
            
            const q = query(
                collection(window.db, publicDataPath),
                where("votes", ">", 0), // 凡是 0 票的魔法卡，都不顯示
            );

            onSnapshot(q, (snapshot) => {
                let newLeaderboard = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // 將人氣榜的數據與卡片細節數據合併，以便顯示 icon 和 color
                    const cardDetail = ORIGINAL_SPELL_DATA.find(c => c.id === doc.id);
                    if (cardDetail) {
                       newLeaderboard.push({ id: doc.id, ...data, icon: cardDetail.icon, color: cardDetail.color });
                    }
                });

                // 在客戶端進行排序：依票數降序排列
                newLeaderboard.sort((a, b) => b.votes - a.votes);
                window.currentLeaderboard = newLeaderboard;
                renderLeaderboard();
            }, (error) => {
                console.error("Leaderboard snapshot error:", error);
                document.getElementById('status').textContent = '人氣榜載入失敗。';
            });
        };

        // 渲染即時人氣榜
        const renderLeaderboard = () => {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';

            if (window.currentLeaderboard.length === 0) {
                list.innerHTML = `<li class="p-4 bg-yellow-50 rounded-lg text-center text-gray-500 font-serif italic">目前沒有魔法獲得蒐藏票數。</li>`;
                return;
            }

            window.currentLeaderboard.forEach((card, index) => {
                const li = document.createElement('li');
                
                // 根據排名設置樣式
                let rankStyle = 'bg-gray-50 text-gray-700';
                if (index === 0) {
                    rankStyle = 'bg-amber-100 text-amber-900 border-l-4 border-amber-500 font-extrabold';
                } else if (index === 1) {
                    rankStyle = 'bg-gray-200 text-gray-800 border-l-4 border-gray-400 font-bold';
                } else if (index === 2) {
                    rankStyle = 'bg-orange-100 text-orange-800 border-l-4 border-orange-300 font-semibold';
                }

                li.className = `p-4 mb-3 rounded-lg flex justify-between items-center shadow-md ${rankStyle} font-serif`;
                
                li.innerHTML = `
                    <div class="flex items-center space-x-4 overflow-hidden">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full bg-white border border-gray-300 font-mono text-sm">${index + 1}</span>
                        <span class="truncate">${card.title}</span>
                    </div>
                    <span class="text-xl font-mono text-red-500">${card.votes} <span class="text-sm">票</span></span>
                `;
                list.appendChild(li);
            });
        };

        // 自定義彈出提示框 (取代 alert())
        const alertUser = (message, isError = false) => {
            const alertBox = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            alertMessage.textContent = message;
            
            alertBox.classList.remove('opacity-0', 'pointer-events-none', 'bg-green-500', 'bg-red-500');
            alertBox.classList.add('opacity-100', isError ? 'bg-red-500' : 'bg-green-500');

            setTimeout(() => {
                alertBox.classList.add('opacity-0', 'pointer-events-none');
                alertBox.classList.remove('opacity-100');
            }, 3000);
        };
        
        // -----------------------------------------------------
        // 卡片渲染與滑動邏輯
        // -----------------------------------------------------
        
        /**
         * 根據資料建立一個卡片 DOM 元素
         */
        function createCard(spell) {
            const card = document.createElement('div');
            card.className = 'spell-card';
            card.setAttribute('data-id', spell.id);
            
            card.innerHTML = `
                <div class="flex-grow flex flex-col items-center justify-center ${spell.color} overflow-hidden">
                    ${spell.icon}
                </div>
                <div class="mt-4 text-center border-t border-gray-200 pt-4">
                    <h2 class="text-2xl font-bold font-serif text-amber-800">${spell.title}</h2>
                    <p class="text-sm text-gray-600 mt-3 spell-description">${spell.description}</p>
                </div>
            `;
            return card;
        }

        /**
         * 渲染卡片堆疊
         */
        function renderCardStack() {
            stack.innerHTML = '';
            
            // 渲染前 3 張卡片以建立堆疊視覺效果
            for (let i = 0; i < 3; i++) {
                let index = (window.currentCardIndex + i) % window.spellData.length;
                const spell = window.spellData[index];
                
                if (spell) {
                    const card = createCard(spell);
                    // 確保卡片是插入在 DOM 堆疊的底部 (CSS 讓它視覺上在頂部)
                    stack.insertBefore(card, stack.firstChild);

                    // 最上層的卡片 (DOM 中的最後一個 child) 獲得互動事件
                    if (i === 0) {
                        currentCard = card;
                        addInteractionListeners(currentCard);
                    }
                }
            }
        }
        
        /**
         * 導航到下一張或上一張卡片
         * @param {number} direction - 1 為下一張 (左滑), -1 為上一張 (右滑)
         */
        function navigateCard(direction) {
            let nextIndex = window.currentCardIndex + direction;

            if (nextIndex >= window.spellData.length) {
                nextIndex = 0; // 循環到開頭
            } else if (nextIndex < 0) {
                nextIndex = window.spellData.length - 1; // 循環到末尾
            }
            
            window.currentCardIndex = nextIndex;
            renderCardStack();
        }

        /**
         * 為卡片添加互動監聽 (拖曳/滑動)
         */
        function addInteractionListeners(card) {
            if (!card) return;
            card.addEventListener('mousedown', onDragStart);
            card.addEventListener('touchstart', onDragStart, { passive: true });
        }

        /**
         * 拖曳開始
         */
        function onDragStart(e) {
            if (e.currentTarget !== stack.lastChild) return;
            if (isDragging) return;
            
            isDragging = true;
            
            currentCard = e.currentTarget;
            currentCard.classList.add('dragging');
            
            startX = e.clientX || e.touches[0].clientX;
            
            window.addEventListener('mousemove', onDragMove);
            window.addEventListener('touchmove', onDragMove, { passive: false });
            
            window.addEventListener('mouseup', onDragEnd);
            window.addEventListener('touchend', onDragEnd);
        }

        /**
         * 拖曳中
         */
        function onDragMove(e) {
            if (!isDragging || !currentCard) return;

            const currentX = e.clientX || e.touches[0].clientX;
            const deltaX = currentX - startX;
            
            // 根據拖曳距離旋轉卡片 (微小的視覺效果)
            const rotate = deltaX / 20; 
            
            currentCard.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;
        }

        /**
         * 拖曳結束
         */
        function onDragEnd(e) {
            if (!isDragging || !currentCard) return;
            isDragging = false;

            // 移除全域監聽
            window.removeEventListener('mousemove', onDragMove);
            window.removeEventListener('touchmove', onDragMove);
            window.removeEventListener('mouseup', onDragEnd);
            window.removeEventListener('touchend', onDragEnd);

            const finalX = e.clientX || e.changedTouches[0].clientX;
            const deltaX = finalX - startX;
            
            const threshold = currentCard.offsetWidth / 3;

            if (Math.abs(deltaX) > threshold) {
                // 滑動成功：執行卡片切換動畫
                const direction = deltaX > 0 ? -1 : 1; // 右滑 (-1) 是上一張, 左滑 (1) 是下一張
                
                const cardToMove = currentCard;
                cardToMove.classList.remove('dragging');
                
                // 快速飛出動畫
                cardToMove.style.transition = 'transform 0.2s ease-in, opacity 0.2s ease-in';
                cardToMove.style.transform = `translateX(${deltaX > 0 ? '500px' : '-500px'}) rotate(${deltaX / 10}deg)`;
                cardToMove.style.opacity = '0';
                
                // 動畫完成後更新狀態和重新渲染
                setTimeout(() => {
                    navigateCard(direction);
                }, 200);

            } else {
                // 滑動失敗：歸位
                snapBack();
            }
        }

        /**
         * 卡片歸位動畫
         */
        function snapBack() {
            if (currentCard) {
                currentCard.classList.remove('dragging');
                currentCard.style.transform = ''; // 清除 transform 樣式，CSS transition 會自動歸位
                currentCard = null;
            }
        }

        // 啟動應用
        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gradient-to-br from-gray-100 via-yellow-50 to-amber-100 text-gray-800 flex flex-col items-center min-h-screen p-4 overflow-x-hidden">

    <!-- 頂部標題 -->
    <div class="text-center mb-6 p-4 bg-white/70 rounded-xl shadow-xl backdrop-blur-sm border-b-2 border-amber-300">
        <h1 class="text-4xl font-extrabold text-amber-900 drop-shadow-md">芙莉蓮的魔法卡冊</h1>
        <p class="text-gray-600 mt-2 font-serif italic">輕觸並滑動卡片來切換，點擊蒐藏來為喜歡的魔法投票！</p>
    </div>

    <!-- Overall Container -->
    <div class="w-full max-w-7xl flex flex-col items-center md:flex-row md:items-start gap-8 flex-grow">
        
        <!-- Left Column: Card Swiper & Collect Button (md:w-3/5) -->
        <div class="md:w-3/5 w-full flex flex-col items-center p-6 bg-white/70 rounded-3xl shadow-2xl backdrop-blur-sm border-4 border-amber-300 min-h-[500px]">
            
            <!-- 狀態顯示 -->
            <p id="status" class="text-sm text-gray-500 mb-4 h-4">正在初始化 Firebase...</p>

            <!-- Card Stack Container -->
            <div id="card-stack" class="card-stack relative w-64 h-80 sm:w-72 sm:h-96 max-w-sm">
                <div class="spell-card flex flex-col items-center justify-center text-center text-gray-500">
                    <h2 class="text-xl font-bold">正在載入卡片...</h2>
                    <p class="mt-2 text-sm">請稍候</p>
                </div>
            </div>

            <!-- Collect Button -->
            <button id="collect-btn" onclick="collectCard()" class="action-button bg-pink-200 hover:bg-pink-300 text-pink-700 font-extrabold rounded-full p-4 px-8 shadow-xl text-lg flex items-center space-x-3 mt-12 disabled:opacity-50 disabled:cursor-not-allowed">
                <!-- Heart Icon for Collect -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span>蒐藏這項魔法</span>
            </button>
            <p class="mt-4 text-sm text-gray-500">向左（下一張）或右（上一張）滑動卡片即可切換。</p>
        </div>

        <!-- Right Column: Real-Time Leaderboard (md:w-2/5) -->
        <div class="md:w-2/5 w-full p-6 bg-white/70 rounded-3xl shadow-2xl backdrop-blur-sm border-4 border-yellow-200">
            <h2 class="text-3xl font-extrabold text-red-700 border-b-4 border-red-200 pb-3 mb-6 font-serif">即時人氣榜</h2>
            <div id="leaderboard" class="h-full max-h-[600px] overflow-y-auto">
                <ul id="leaderboard-list" class="space-y-3">
                    <li class="p-4 bg-yellow-50 rounded-lg text-center text-gray-500 font-serif italic">正在載入人氣數據...</li>
                </ul>
            </div>
        </div>

    </div>
    
    <!-- Custom Alert Box (取代 alert/confirm) -->
    <div id="custom-alert" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none transform translate-y-0 z-50">
        <span id="alert-message" class="font-semibold"></span>
    </div>

</body>
</html>