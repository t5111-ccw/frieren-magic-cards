<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ™è‰è“®çš„æ°‘é–“é­”æ³•èˆ‡äººæ°£æ¦œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­ç½®è¥¯ç·šå­—é«”ï¼ˆSerifï¼‰ï¼Œä½¿å…¶çœ‹èµ·ä¾†æ›´åƒé­”å°æ›¸ã€‚ */
        body {
            font-family: 'Times New Roman', Georgia, serif, 'Noto Sans TC';
        }
        
        /* æé«˜å †ç–Šä¸­å¡ç‰‡çš„å±¤æ¬¡æ„Ÿå’Œé‚Šæ¡†ç´°ç¯€ */
        .card-stack .spell-card {
            /* 1. çµ•å°å®šä½ï¼Œä½¿å¡ç‰‡é‡ç–Š */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* 2. å¡ç‰‡å¤–è§€ */
            background: white;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.2), 0 5px 10px -2px rgba(0, 0, 0, 0.05); /* å¢å¼·é™°å½± */
            border: 4px solid #FCD34D; /* æ·ºé‡‘è‰²é‚Šæ¡†ï¼Œå¢å¼·é­”æ³•æ›¸è³ªæ„Ÿ */
            
            /* 3. å…§å®¹æ’ç‰ˆ */
            display: flex;
            flex-direction: column;
            padding: 2rem; /* p-8 */
            
            /* 4. é˜²æ­¢é¸å–æ–‡å­— */
            user-select: none;
            
            /* 5. è¨­ç½®éæ¸¡å‹•ç•« (åƒ…ç”¨æ–¼å¡ç‰‡åˆ‡æ›å¾Œçš„å †ç–Šæ­¸ä½) */
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 

            /* 6. è¨­ç½® cursor æ¨£å¼ (é›–ç„¶æ»‘å‹•åŠŸèƒ½å·²ç§»é™¤ï¼Œä½†ä¿ç•™ grab è¦–è¦ºæ•ˆæœ) */
            cursor: default; 
            
            /* 7. ç¢ºä¿å¡ç‰‡å…§å®¹åœ¨é ‚å±¤æ¸…æ™° */
            z-index: 10;
        }
        
        /* å †ç–Šä¸­ç¬¬äºŒå¼µå¡ç‰‡çš„æ¨£å¼ */
        .card-stack .spell-card:nth-child(2) {
            transform: scale(0.95) translateY(15px);
            z-index: 5;
            opacity: 0.85;
            border-color: #FED7AA; /* æ¬¡è¦å¡ç‰‡ä½¿ç”¨è¼ƒæ·¡çš„é‚Šæ¡†è‰² */
        }
        
        /* ç¬¬ä¸‰å¼µå¡ç‰‡ */
        .card-stack .spell-card:nth-child(3) {
            transform: scale(0.9) translateY(30px);
            z-index: 0;
            opacity: 0.7;
            border-color: #FED7AA;
        }
        
        /* éš±è—æ›´å¾Œé¢çš„å¡ç‰‡ */
        .card-stack .spell-card:nth-child(n+4) {
            opacity: 0;
            z-index: -5;
        }

        /* å¡ç‰‡å…§æ–‡æ¨£å¼ */
        .spell-description {
            height: 100px; /* å›ºå®šé«˜åº¦ */
            overflow-y: auto; 
            scrollbar-width: thin;
            scrollbar-color: #9CA3AF #F3F4F6;
        }

        /* äººæ°£æ¦œæ¨£å¼ */
        #leaderboard::-webkit-scrollbar {
            width: 6px;
        }
        #leaderboard::-webkit-scrollbar-thumb {
            background-color: #FCD34D;
            border-radius: 3px;
        }
        #leaderboard::-webkit-scrollbar-track {
            background: #fef3c7;
        }
    </style>
    <script type="module">
        self.FIREBASE_FIRESTORE_LOG_LEVEL = "debug";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, getDoc, runTransaction, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- å…¨åŸŸè®Šæ•¸ ---
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.sessionId = null; // **NEW: æ¯æ¬¡è¬›åº§çš„å”¯ä¸€ ID**
        window.currentCardIndex = 0;
        window.currentLeaderboard = [];
        window.spellData = []; // ç”¨æ–¼å„²å­˜è¦å¾ªç’°çš„å¡ç‰‡è³‡æ–™
        
        // ä¾†è‡ª Heroicons çš„ SVG åœ–æ¨™ (ä¿æŒä¸è®Š)
        const ICONS = {
            flower: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.195l-2.073.193c-1.11.103-2.064.957-2.064 2.08V20.25c0 1.136-.847 2.1-1.98 2.195l-2.073.193c-1.11.103-2.064.957-2.064 2.08V20.25" /><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 12.75l-1.01-1.01-1.01 1.01m1.01-1.01v-1.01h1.01m-1.01 1.01h-1.01v-1.01m0 0v1.01M3.75 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.195l-2.073.193C-.103 17.217-.947 16.263-.947 15.131v-4.286c0-.97.616-1.813 1.5-2.097L3.75 8.511zM12.75 3.75l-1.01 1.01-1.01-1.01m1.01 1.01v1.01h1.01m-1.01-1.01h-1.01v1.01m0 0v1.01M15 4.75l.939-.939a.95.95 0 011.061 0l.939.939M15 4.75l.939.939m-.939-.939v1.879M15 4.75h1.879m-1.879 0L13.94 3.811M9 4.75l-.939-.939a.95.95 0 00-1.061 0l-.939.939M9 4.75l-.939.939m.939-.939v1.879M9 4.75H7.121m1.879 0L10.06 3.811" /></svg>',
            grape: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            statue: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A1.5 1.5 0 0118 21.75H6a1.5 1.5 0 01-1.499-1.632z" /></svg>',
            burger: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0A2.25 2.25 0 0018.75 9.75H5.25A2.25 2.25 0 003 12m18 0a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12" /></svg>',
            tea: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-1.718-.668-3.322-1.872-4.526A4.498 4.498 0 009 0C7.161 0 5.5 1.66 5.5 3.75v.063c-.441.246-.85.539-1.208.882A4.5 4.5 0 000 8.25v3.75c0 1.683.806 3.19 2.009 4.093l.3.218c.847.62 1.935.939 3.065.939h6.38a.563.563 0 00.563-.563v-3.87a.563.563 0 00-.31-.5l-2.65-1.06a1.126 1.126 0 01-.562-1.332c.11-.27.27-.52.478-.736.209-.215.46-.38.74-.487.278-.106.574-.16.882-.16h.063c1.02 0 1.96.402 2.65 1.126l2.5 2.5c.26.26.628.402 1.006.402h3.116c1.1 0 2.097-.81 2.308-1.9l.792-4.062a2.25 2.25 0 00-2.16-2.618l-3.86-.551Z" /></svg>',
            clothes: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>',
            bird: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L5.999 12zm0 0h7.5" /></svg>',
            search: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>',
            egg: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
        };

        // é­”æ³•å¡ç‰‡è³‡æ–™ (ä¿æŒä¸è®Š)
        const ORIGINAL_SPELL_DATA = [
            {
                id: "flower_magic",
                title: "è®Šå‡ºèŠ±ç”°çš„é­”æ³•",
                icon: ICONS.flower,
                color: "text-pink-600",
                description: "èŠ™è‰è“®æœ€çè¦–çš„é­”æ³•ä¹‹ä¸€ã€‚æ¬£æ¢…çˆ¾çš„æ•…é„‰ç››é–‹è‘—è’¼æœˆè‰ï¼Œé€™æ˜¯ä»–æœ€å–œæ­¡çš„é­”æ³•ï¼Œä¹Ÿæ˜¯é€£çµå¸«å‚…å¼—è˜­æ¢…çš„é­”æ³•ã€‚"
            },
            {
                id: "grape_magic",
                title: "æŠŠç”œè‘¡è„è®Šæˆé…¸è‘¡è„çš„é­”æ³•",
                icon: ICONS.grape,
                color: "text-purple-700",
                description: "ç´”ç²¹æ˜¯ç‚ºäº†è®“æˆ°å£«è‰¾å†‰é–‹å¿ƒè€Œå­¸çš„ã€‚è‰¾å†‰å”¯ä¸€å–œæ­¡çš„ç”œé»å°±æ˜¯é…¸è‘¡è„ã€‚"
            },
            {
                id: "statue_magic",
                title: "å»é™¤éŠ…åƒç”Ÿé½çš„é­”æ³•",
                icon: ICONS.statue,
                color: "text-yellow-700",
                description: "æ¬£æ¢…çˆ¾éä¸–å¾Œï¼ŒèŠ™è‰è“®åœ¨æ—…é€”ä¸­ç”¨ä¾†ã€Œæ¢æœ›ã€è€æœ‹å‹çš„é­”æ³•ï¼Œä»”ç´°åœ°æ¸…æ½”ä»–çš„é›•åƒã€‚"
            },
            {
                id: "burger_magic",
                title: "å¬å–šè¶…å·¨å¤§æ¼¢å ¡æ’çš„é­”æ³•",
                icon: ICONS.burger,
                color: "text-orange-700",
                description: "åƒ§ä¾¶æµ·å¡”é–‹ç©ç¬‘æƒ³è¦çš„é­”æ³•ã€‚èŠ™è‰è“®çœŸçš„èŠ±äº†å¥½å¹¾å¹´å»æ‰¾ï¼Œé«”ç¾äº†å¥¹å°å¤¥ä¼´é¡˜æœ›çš„ï¼ˆç¬¨æ‹™ï¼‰é‡è¦–ã€‚"
            },
            {
                id: "tea_magic",
                title: "è®Šå‡ºç†±èŒ¶çš„é­”æ³•",
                icon: ICONS.tea,
                color: "text-green-700",
                description: "åœ¨å¯’å†·çš„æ—…é€”ä¸­ï¼Œèƒ½éš¨æ™‚å–åˆ°ç†±èŒ¶ã€‚é€™æ˜¯èŠ™è‰è“®å’Œè²»å€«åœ¨æ—¥å¸¸ä¸­ç¶“å¸¸ä½¿ç”¨çš„ä¾¿åˆ©é­”æ³•ã€‚"
            },
            {
                id: "clothes_magic",
                title: "èƒ½çœ‹é€è¡£æœçš„é­”æ³•",
                icon: ICONS.clothes,
                color: "text-blue-700",
                description: "ã€Œå¥½è‰²ã€‚ã€â€”â€” è²»å€«ã€‚èŠ™è‰è“®ç´”ç²¹å‡ºæ–¼é­”æ³•å®…çš„å¥½å¥‡å¿ƒè€Œæ”¶è—ï¼Œå®Œå…¨ä¸æ˜ç™½é€™å€‹é­”æ³•çš„å€«ç†å«æ„ã€‚"
            },
            {
                id: "bird_magic",
                title: "æ•é³¥çš„é­”æ³•",
                icon: ICONS.bird,
                color: "text-sky-700",
                description: "ç”¨é€”ä¸æ˜çš„é­”æ³•ã€‚ä½†åœ¨æŸæ¬¡æ—…é€”ä¸­ï¼Œä¿®å¡”çˆ¾å…‹é€ƒè·‘æ™‚ï¼ŒèŠ™è‰è“®æ›¾ç”¨é€™å€‹é­”æ³•æŠŠä»–æŠ“å›ä¾†ã€‚"
            },
            {
                id: "search_magic",
                title: "å°‹æ‰¾å¤±ç‰©çš„é­”æ³•",
                icon: ICONS.search,
                color: "text-gray-700",
                description: "åœ¨æ—¥å¸¸ä¸­éå¸¸å¯¦ç”¨ï¼Œç”¨ä¾†å¹«æ‘æ°‘æˆ–å¤¥ä¼´å°‹æ‰¾éºå¤±çš„å°æ±è¥¿ï¼Œä¾‹å¦‚è€³ç’°æˆ–ç´€å¿µå“ã€‚"
            },
            {
                id: "egg_magic",
                title: "æ‰“ç¢é›è›‹æ™‚è›‹æ®¼çµ•å°ä¸æœƒæ‰é€²å»çš„é­”æ³•",
                icon: ICONS.egg,
                color: "text-amber-700",
                description: "å»šæˆ¿çš„å¤¢å¹»é­”æ³•ã€‚èŠ™è‰è“®èŠ±äº†ä¸çŸ­çš„æ™‚é–“æ‰å¾ä¸€æœ¬é­”å°æ›¸ä¸­å­¸æœƒå®ƒï¼Œæ˜¯å¥¹ç†±è¡·æ–¼æå‡ç”Ÿæ´»å“è³ªçš„è­‰æ˜ã€‚"
            }
        ];

        // --- 2. è®Šæ•¸èˆ‡ DOM å…ƒç´ å®šç¾© ---
        const stack = document.getElementById('card-stack');
        let currentCard = null; // ç•¶å‰æ­£åœ¨é¡¯ç¤ºçš„ DOM å¡ç‰‡

        // -----------------------------------------------------
        // Firebase èˆ‡ Firestore é‚è¼¯
        // -----------------------------------------------------

        /**
        * **NEW** å–å¾—ç•¶å‰è¬›åº§çš„ Firestore è·¯å¾‘
        * é€™æ¨£æ¯æ¬¡è¼‰å…¥ç¶²é éƒ½æœƒä½¿ç”¨ä¸åŒçš„è·¯å¾‘ï¼Œå¯¦ç¾æ•¸æ“šé‡ç½®ã€‚
        */
        const getFirestorePath = () => {
            // ä½¿ç”¨ sessions/[å”¯ä¸€ ID]/magic_cards ä¾†éš”é›¢æ•¸æ“š
            return `sessions/${window.sessionId}/frieren_magic_cards`; 
        }

        // Firebase åˆå§‹åŒ–èˆ‡èªè­‰
        const initFirebase = async () => {
            try {
                // -------------------------------------------------------------------
                // ** éƒ¨ç½²ä¿®æ­£ï¼šé€™æ˜¯æ‚¨å¿…é ˆå¡«å…¥è‡ªå·± Firebase é…ç½®çš„åœ°æ–¹ **
                const YOUR_FIREBASE_CONFIG = {
                    apiKey: "AIzaSyBYWpbdDJ7mV1Rj59HaSMKV-uyp1hrRzP0", // <-- è«‹å¡«å…¥æ‚¨çš„ API Key
                    authDomain: "frieren-magic-cards.firebaseapp.com", // <-- è«‹å¡«å…¥æ‚¨çš„ Auth Domain (ä¾‹å¦‚: your-project-id.firebaseapp.com)
                    projectId: "frieren-magic-cards", // <-- è«‹å¡«å…¥æ‚¨çš„ Project ID
                    storageBucket: "frieren-magic-cards.appspot.com",
                    messagingSenderId: "871120496838",
                    appId: "1:871120496838:web:cafa773f25964e8d7e0fc7",
                    measurementId: "G-S8Z9BW7XRX"
                };
                // -------------------------------------------------------------------

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                let firebaseConfig = YOUR_FIREBASE_CONFIG;
                if (typeof __firebase_config !== 'undefined') {
                    const canvasConfig = JSON.parse(__firebase_config);
                    if (Object.keys(canvasConfig).length > 0) {
                        firebaseConfig = canvasConfig;
                    }
                }
                
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                    console.error("Firebase config is missing or invalid.");
                    document.getElementById('status').textContent = 'éŒ¯èª¤ï¼šFirebase è¨­å®šéºå¤±ã€‚è«‹æª¢æŸ¥ YOUR_FIREBASE_CONFIG æ˜¯å¦å·²å¡«å…¥ã€‚';
                    return;
                }

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                window.sessionId = crypto.randomUUID(); // **NEW: ç”¢ç”Ÿæœ¬æ¬¡è¬›åº§çš„å”¯ä¸€ ID**

                document.getElementById('status').textContent = 'Firebase é€£ç·šæˆåŠŸï¼Œè¼‰å…¥è³‡æ–™ä¸­...'; // éšæ®µä¸€ç‹€æ…‹

                window.spellData = ORIGINAL_SPELL_DATA; // è¼‰å…¥å¡ç‰‡è³‡æ–™
                await setupInitialCards();
                setupRealtimeLeaderboard();
                renderCardStack();
                
                // è¼‰å…¥å®Œæˆï¼Œé¡¯ç¤ºæˆåŠŸè¨Šæ¯ä¸¦è¨­å®šè¨ˆæ™‚å™¨æ¸…é™¤
                document.getElementById('status').textContent = 'æˆåŠŸï¼èŠ™è‰è“®çš„é­”æ³•æ›¸å·²é–‹å•Ÿã€‚';
                setTimeout(() => {
                    document.getElementById('status').textContent = ''; // 3 ç§’å¾Œæ¸…é™¤è¨Šæ¯
                }, 3000);
                // -----------------------------------------------

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                // é¡¯ç¤ºç‰¹å®šçš„éŒ¯èª¤è¨Šæ¯ï¼Œæœ‰åŠ©æ–¼é™¤éŒ¯
                document.getElementById('status').textContent = `éŒ¯èª¤ï¼šFirebase åˆå§‹åŒ–å¤±æ•— (${error.message})`;
            }
        };

        // è¨­ç½®åˆå§‹å¡ç‰‡ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        const setupInitialCards = async () => {
            if (!window.db) return;
            
            // **ä¿®æ­£é»ï¼šä½¿ç”¨ session-specific è·¯å¾‘**
            const sessionDataPath = getFirestorePath();
            
            const batch = writeBatch(window.db);
            let needsUpdate = false;

            for (const card of window.spellData) {
                const docRef = doc(window.db, sessionDataPath, card.id); // <-- ä½¿ç”¨æ–°è·¯å¾‘
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    batch.set(docRef, {
                        title: card.title,
                        votes: 0 // åˆå§‹ç¥¨æ•¸ç‚º 0
                    });
                    needsUpdate = true;
                }
            }

            if (needsUpdate) {
                try {
                    await batch.commit();
                } catch (e) {
                    console.error("Batch write failed:", e);
                }
            }
        };

        /**
        * é»æ“Šè’è—ï¼ˆå¢åŠ ç¥¨æ•¸ï¼‰
        */
        window.collectCard = async () => {
            if (!window.db || !window.auth || window.spellData.length === 0) {
                alertUser('è«‹ç¨å€™ï¼Œç³»çµ±ä»åœ¨åˆå§‹åŒ–...');
                return;
            }
            // ğŸ’¥ NEW: å¾ DOM ä¸­ç²å–æœ€é ‚å±¤å¡ç‰‡çš„è³‡æ–™
    const activeCardDom = document.getElementById('current-active-card');
    const cardIdToUpdate = activeCardDom ? activeCardDom.getAttribute('data-id') : null;
    
    if (!cardIdToUpdate) {
        alertUser('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¦è’è—çš„é­”æ³•å¡ IDã€‚', true);
        return;
    }
           // å–å¾—å®Œæ•´çš„å¡ç‰‡ç‰©ä»¶ï¼Œä»¥ä¾¿ç²å– title (ç”¨æ–¼ alert)
    const card = window.spellData.find(c => c.id === cardIdToUpdate);

    // ç¢ºä¿ getFirestorePath() å‡½å¼å·²ç¶“ä½¿ç”¨ 'frieren_magic_cards'
    const sessionDataPath = getFirestorePath(); 
    const docRef = doc(window.db, sessionDataPath, cardIdToUpdate); // <-- ä½¿ç”¨ DOM å‚³éçš„ ID

    try {
        await runTransaction(window.db, async (transaction) => {
            const cardDoc = await transaction.get(docRef);
            // ... (å¾ŒçºŒçš„ transaction é‚è¼¯ä¸è®Š)
            
            if (cardDoc.exists()) {
                const newVotes = (cardDoc.data().votes || 0) + 1;
                transaction.update(docRef, { votes: newVotes });
                alertUser(`æˆåŠŸè’è—ï¼ã€Œ${card.title}ã€çš„ç¥¨æ•¸å·²æ›´æ–°ç‚º ${newVotes}ã€‚`);
            } else {
                // ... æ•¸æ“šç¼ºå¤±æ™‚ï¼Œå‰µå»ºä¸¦è¨­å®šåˆå§‹ç¥¨æ•¸ 1 ...
            }
        });
    } catch (error) {
        console.error("Collecting card failed:", error);
        alertUser(`è’è—å¤±æ•—ï¼š${error.message}`, true);
    }
};

        // è¨­ç½®å³æ™‚äººæ°£æ¦œç›£è½å™¨
        const setupRealtimeLeaderboard = () => {
            if (!window.db) return;
            
            // **ä¿®æ­£é»ï¼šä½¿ç”¨ session-specific è·¯å¾‘**
            const sessionDataPath = getFirestorePath();
            
            const q = query(
                collection(window.db, sessionDataPath), // <-- ä½¿ç”¨æ–°è·¯å¾‘
                where("votes", ">", 0), // å‡¡æ˜¯ 0 ç¥¨çš„é­”æ³•å¡ï¼Œéƒ½ä¸é¡¯ç¤º
            );

            onSnapshot(q, (snapshot) => {
                let newLeaderboard = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // å°‡äººæ°£æ¦œçš„æ•¸æ“šèˆ‡å¡ç‰‡ç´°ç¯€æ•¸æ“šåˆä½µï¼Œä»¥ä¾¿é¡¯ç¤º icon å’Œ color
                    const cardDetail = ORIGINAL_SPELL_DATA.find(c => c.id === doc.id);
                    if (cardDetail) {
                       newLeaderboard.push({ id: doc.id, ...data, icon: cardDetail.icon, color: cardDetail.color });
                    }
                });

                // åœ¨å®¢æˆ¶ç«¯é€²è¡Œæ’åºï¼šä¾ç¥¨æ•¸é™åºæ’åˆ—
                newLeaderboard.sort((a, b) => b.votes - a.votes);
                window.currentLeaderboard = newLeaderboard;
                renderLeaderboard();
            }, (error) => {
                console.error("Leaderboard snapshot error:", error);
                document.getElementById('status').textContent = 'äººæ°£æ¦œè¼‰å…¥å¤±æ•—ã€‚';
            });
        };

        // æ¸²æŸ“å³æ™‚äººæ°£æ¦œ
        const renderLeaderboard = () => {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';

            if (window.currentLeaderboard.length === 0) {
                list.innerHTML = `<li class="p-4 bg-yellow-50 rounded-lg text-center text-gray-500 font-serif italic">ç›®å‰æ²’æœ‰é­”æ³•ç²å¾—è’è—ç¥¨æ•¸ã€‚</li>`;
                return;
            }

            window.currentLeaderboard.forEach((card, index) => {
                const li = document.createElement('li');
                
                // æ ¹æ“šæ’åè¨­ç½®æ¨£å¼
                let rankStyle = 'bg-gray-50 text-gray-700';
                if (index === 0) {
                    rankStyle = 'bg-amber-100 text-amber-900 border-l-4 border-amber-500 font-extrabold';
                } else if (index === 1) {
                    rankStyle = 'bg-gray-200 text-gray-800 border-l-4 border-gray-400 font-bold';
                } else if (index === 2) {
                    rankStyle = 'bg-orange-100 text-orange-800 border-l-4 border-orange-300 font-semibold';
                }

                li.className = `p-4 mb-3 rounded-lg flex justify-between items-center shadow-md ${rankStyle} font-serif`;
                
                li.innerHTML = `
                    <div class="flex items-center space-x-4 overflow-hidden">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full bg-white border border-gray-300 font-mono text-sm">${index + 1}</span>
                        <span class="truncate">${card.title}</span>
                    </div>
                    <span class="text-xl font-mono text-red-500">${card.votes} <span class="text-sm">ç¥¨</span></span>
                `;
                list.appendChild(li);
            });
        };

        // è‡ªå®šç¾©å½ˆå‡ºæç¤ºæ¡† (å–ä»£ alert/confirm)
        const alertUser = (message, isError = false) => {
            const alertBox = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            alertMessage.textContent = message;
            
            alertBox.classList.remove('opacity-0', 'pointer-events-none', 'bg-green-500', 'bg-red-500');
            alertBox.classList.add('opacity-100', isError ? 'bg-red-500' : 'bg-green-500');

            setTimeout(() => {
                alertBox.classList.add('opacity-0', 'pointer-events-none');
                alertBox.classList.remove('opacity-100');
            }, 3000);
        };
        
        // -----------------------------------------------------
        // å¡ç‰‡æ¸²æŸ“èˆ‡æ»‘å‹•é‚è¼¯
        // -----------------------------------------------------
        
        /**
        * æ ¹æ“šè³‡æ–™å»ºç«‹ä¸€å€‹å¡ç‰‡ DOM å…ƒç´ 
        */
        function createCard(spell) {
            const card = document.createElement('div');
            card.className = 'spell-card';
            card.setAttribute('data-id', spell.id);
            
            card.innerHTML = `
                <div class="flex-grow flex flex-col items-center justify-center ${spell.color} overflow-hidden">
                    ${spell.icon}
                </div>
                <div class="mt-4 text-center border-t border-gray-200 pt-4">
                    <h2 class="text-2xl font-bold font-serif text-amber-800">${spell.title}</h2>
                    <p class="text-sm text-gray-600 mt-3 spell-description">${spell.description}</p>
                </div>
            `;
            return card;
        }

        /**
        * æ¸²æŸ“å¡ç‰‡å †ç–Š
        */
        function renderCardStack() {
            stack.innerHTML = '';
            
            // æ¸²æŸ“å‰ 3 å¼µå¡ç‰‡ä»¥å»ºç«‹å †ç–Šè¦–è¦ºæ•ˆæœ
            for (let i = 0; i < 3; i++) {
                let index = (window.currentCardIndex + i) % window.spellData.length;
                const spell = window.spellData[index];
                
                if (spell) {
                    const card = createCard(spell);
                    // ç¢ºä¿å¡ç‰‡æ˜¯æ’å…¥åœ¨ DOM å †ç–Šçš„åº•éƒ¨ (CSS è®“å®ƒè¦–è¦ºä¸Šåœ¨é ‚éƒ¨)
                    stack.insertBefore(card, stack.firstChild);

                    // æœ€ä¸Šå±¤çš„å¡ç‰‡ (DOM ä¸­çš„æœ€å¾Œä¸€å€‹ child) ç²å¾—äº’å‹•äº‹ä»¶
                    if (i === 0) {
                        currentCard = card;
                        // ğŸ’¥ NEW: çµ¦æœ€ä¸Šå±¤çš„å¡ç‰‡ä¸€å€‹ç‰¹å®šçš„ ID
                card.id = 'current-active-card';
                    }
                }
            }
        }
        
        /**
        * å°èˆªåˆ°ä¸‹ä¸€å¼µæˆ–ä¸Šä¸€å¼µå¡ç‰‡
        * @param {number} direction - 1 ç‚ºä¸‹ä¸€å¼µ (å³æŒ‰éˆ•), -1 ç‚ºä¸Šä¸€å¼µ (å·¦æŒ‰éˆ•)
        */
        window.navigateCard = (direction) => { // è®“å®ƒå¯ä»¥åœ¨ HTML ä¸­è¢«èª¿ç”¨
            let nextIndex = window.currentCardIndex + direction;

            if (nextIndex >= window.spellData.length) {
                nextIndex = 0; // å¾ªç’°åˆ°é–‹é ­
            } else if (nextIndex < 0) {
                nextIndex = window.spellData.length - 1; // å¾ªç’°åˆ°æœ«å°¾
            }
            
            window.currentCardIndex = nextIndex;
            renderCardStack();
        }

        // å•Ÿå‹•æ‡‰ç”¨
        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gradient-to-br from-gray-100 via-yellow-50 to-amber-100 text-gray-800 flex flex-col items-center min-h-screen p-4 overflow-x-hidden">

    <div class="text-center mb-6 p-4 bg-white/70 rounded-xl shadow-xl backdrop-blur-sm border-b-2 border-amber-300">
        <h1 class="text-4xl font-extrabold text-amber-900 drop-shadow-md">èŠ™è‰è“®çš„æ°‘é–“é­”æ³•</h1>
        <p class="text-gray-600 mt-2 font-serif italic">è¼•è§¸å·¦å³ç®­é ­ä¾†åˆ‡æ›ï¼Œé»æ“Šè’è—é­”æ³•ä¾†ç‚ºå–œæ­¡çš„é­”æ³•æŠ•ç¥¨ï¼</p>
    </div>

    <div class="w-full max-w-7xl flex flex-col items-center md:flex-row md:items-start gap-8 flex-grow">
        
        <div class="md:w-3/5 w-full flex flex-col items-center p-6 bg-white/70 rounded-3xl shadow-2xl backdrop-blur-sm border-4 border-amber-300 min-h-[500px]">
            
            <p id="status" class="text-sm text-gray-500 mb-4 h-4">æ­£åœ¨åˆå§‹åŒ– Firebase...</p>

            <div class="relative flex items-center justify-center w-full max-w-lg mt-4 mb-8">
                <button onclick="navigateCard(-1)" class="p-3 rounded-full bg-white/80 hover:bg-white text-amber-500 shadow-lg transition-all duration-150 transform hover:scale-110 z-20 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                </button>

                <div id="card-stack" class="card-stack relative w-64 h-80 sm:w-72 sm:h-96 max-w-sm mx-4">
                    <div class="spell-card flex flex-col items-center justify-center text-center text-gray-500">
                        <h2 class="text-xl font-bold">æ­£åœ¨è¼‰å…¥å¡ç‰‡...</h2>
                        <p class="mt-2 text-sm">è«‹ç¨å€™</p>
                    </div>
                </div>

                <button onclick="navigateCard(1)" class="p-3 rounded-full bg-white/80 hover:bg-white text-amber-500 shadow-lg transition-all duration-150 transform hover:scale-110 z-20 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>


            <button id="collect-btn" onclick="collectCard()" class="action-button bg-pink-200 hover:bg-pink-300 text-pink-700 font-extrabold rounded-full p-4 px-8 shadow-xl text-lg flex items-center space-x-3 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span>è’è—é€™é …é­”æ³•</span>
            </button>
            <p class="mt-4 text-sm text-gray-500">æ‚¨å¯ä»¥ä½¿ç”¨å·¦å³ç®­é ­ä¾†åˆ‡æ›é­”æ³•ã€‚</p>
        </div>

        <div class="md:w-2/5 w-full p-6 bg-white/70 rounded-3xl shadow-2xl backdrop-blur-sm border-4 border-yellow-200">
            <h2 class="text-3xl font-extrabold text-red-700 border-b-4 border-red-200 pb-3 mb-6 font-serif">å³æ™‚äººæ°£æ¦œ</h2>
            <div id="leaderboard" class="h-full max-h-[600px] overflow-y-auto">
                <ul id="leaderboard-list" class="space-y-3">
                    <li class="p-4 bg-yellow-50 rounded-lg text-center text-gray-500 font-serif italic">æ­£åœ¨è¼‰å…¥äººæ°£æ•¸æ“š...</li>
                </ul>
            </div>
        </div>

    </div>
    
    <div id="custom-alert" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none transform translate-y-0 z-50">
        <span id="alert-message" class="font-semibold"></span>
    </div>

</body>
</html>


